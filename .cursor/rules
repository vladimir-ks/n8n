# Cursor Rules for n8n Deployment Repository

## Critical: Upstream Merges and Custom Deployment Fixes

This repository contains **custom deployment fixes** that are specific to Render.com deployment and MUST be preserved during upstream merges. These fixes are NOT part of the upstream n8n repository.

### ⚠️ NEVER Use `-X theirs` Strategy for Merges

**CRITICAL RULE:** When merging from upstream, NEVER use `git merge -X theirs` as this will discard important upstream changes and can break the build.

### Recommended Merge Workflow

**You MUST use the merge helper script.** This is the only approved method for merging upstream changes.

```bash
./scripts/merge-upstream.sh
```

This script is designed to handle the complexities of this repository and will:
1.  **Verify** that your local custom fixes are intact before starting.
2.  **Fetch** upstream changes and **warn you** if any of our customized files have been changed upstream.
3.  **Guide you** through resolving any merge conflicts.
4.  **Automatically restore and verify** our custom fixes after the merge attempt.
5.  **Stage** all changes, leaving the final commit action for you.

This workflow ensures we integrate upstream updates correctly while guaranteeing our deployment-specific fixes are never lost.

### Custom Deployment Fixes That Must Be Preserved

The merge script manages fixes in these files:

1. **`packages/frontend/editor-ui/vite.config.mts`** (Rolldown dedupe configuration)
2. **`packages/@n8n/codemirror-lang-sql/package.json`** (`@lezer/common` dependency)
3. **`.gitignore`** (Private file entries)

See `CUSTOM_DEPLOYMENT_FIXES.md` for complete details on each fix.

### If Merge Conflicts Occur

The `merge-upstream.sh` script will pause and instruct you on how to proceed. Your primary goal during conflict resolution is to:
1.  Integrate the changes from upstream.
2.  Ensure our custom modifications are still present.
3.  Let the script continue; it will verify the result for you.

### What to Do If Fixes Are Overwritten

The script handles this automatically. After your merge conflict resolution, it runs a restore and verify step. If verification fails, it will halt and provide instructions.

### Documentation

- See `CUSTOM_DEPLOYMENT_FIXES.md` for detailed documentation of all custom fixes.
- See `CLAUDE.md` for general development guidelines.

## General Development Rules

- Always use `pnpm`